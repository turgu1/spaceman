Préparations pour environnement de gestion des installations/mises-à-niveau de spaceman et sciencia dans machine virtuelle Ubuntu 18.04 LTS

Ce document explique comment préparer le poste virtuel à partir duquel les installations et les mises-à-jour de spaceman et sciencia pourront être effectuées. Le poste peut également servir au développement de nouvelles fonctionalités car tous les outils associés à l'environnemnt de développement seront installés.

Contrairement aux installations effectuées avant 2018, les deux applications seront installées en utilisant le même compte utilisateur sur un seul serveur.

Les deux applications sciencia et spaceman utilisant les mêmes versions de ruby et ruby on rails, leur environnement d'exécution est très similaire. La procédure indiquée ici n'a besoin d'être appliquée q'une seule fois. Elle contient tous les éléments requis pour les deux applications.

Comme dans l'avenir les deux applications pourraient ne pas être synchro dans l'utilisation d'une même version de ruby et ruby on rails, les outils de ces deux technologies seront installés de telle sorte que plusieurs versions pourront cohabiter sur le serveur, ceci grâce à l'outil nommé rbenv.

Voici donc la procédure. Les lignes débutant par un $ sont les commandes à exécuter dans une session ssh ou via une application de type "terminal".

Les éléments suivants doivent être ajustés dans le texte pour correspondre aux noms ciblés dans le réseau et sur les ordinateurs impliqués:

  appserv: 
     Nom du serveur virtuel des applications en production

  appdev:
     Nom de la machine virtuel d’où les applications seront installées

  admserv: 
     Nom de l'utilisateur administrateur sur appserv

  admdev: 
     Nom de l'utilisateur administrateur sur appdev

  userdev: 
     Nom de l'utilisateur qui servira à installer les applications à partir de appdev (peut être le même utilisateur admdev)

  userserv: 
     Nom de l'utilisateur qui sera propriétaire des applications en production (ne peut pas être admserv pour des raisons de sécurité)

1. Téléchargement de la version ISO Ubuntu Desktop 18.04 LTS (ou XUbuntu)

2. Installation de appdev et login comme usager admdev

3. Installation des outils de base:
   
   $ sudo apt install git

4. Changement de nom de host:

   $ cd /etc
   $ sudo hostname appdev
   $ sudo nano hostname       --> modifier ubuntu pour appdev
   $ sudo nano hosts          --> modifier ubuntu pour appdev

5. Changement de la date et heure pour EST. (choisir America / Montreal):
   
   $ sudo dpkg-reconfigure tzdata

6. Installer anti-virus et outil de gestion réseau

7. Creation du compte userdev si différent de admdev

   [ on est dans admdev@appdev ]

   $ sudo adduser userdev
   ... répondre aux questions de l'outil...

   Autoriser le compte à effectuer des commandes sudo (superuser)

   $ sudo usermod -aG sudo userdev

   Créer le répertoire .ssh pour admdev:

   $ mkdir ~/.ssh
   $ chmod 700 ~/.ssh

8. login userdev@appdev (ou admdev@appdev si on ne veut pas utiliser un autre utilisateur)

   Ajouter une entrée dans sudoers pour que l'utilisateur admdev puisse utiliser sudo sans mot de passe: requis pour capistrano lors du staging.
   
    [on est sur admdev@appdev]

    $ sudo sh -c 'echo "admdev ALL=NOPASSWD: ALL" >/etc/sudoers.d/admdev'
    $ sudo chmod 440 /etc/sudoers.d/admdev

9. Téléchargement de l'outil d'installation:

   $ mkdir ~/Dev
   $ cd ~/Dev
   $ git clone https://github.com/turgu1/installer.git
   $ cd installer

10. Lancer le processus d'installation. Celui-ci effectuera les modifications suivantes:

    - mise à niveau de l'OS (apt update/upgrade)
    - installation de ruby et de ses dépendances
    - installation de openssh pour permettre l'accès à ce poste en mode ssh
    - installation de capistrano (applications ruby)
    - téléchargement des applications sciencia et spaceman en provenance de github

    Il sera nécessaire d'entrer le mot de passe du compte utilisateur pour les commandes sudo. Lorsque la mise à jour du poste débutera, il faudra répondre Y (yes) à la question de mise à niveau et ce, à deux reprises. L'application Bundle demandera le mot-de-passe de l'utilisateur afin d'installer les applications ruby propres à capistrano:

    $ ./install.sh
    $ cd ..

11. Creation de la clé rsa pour userdev. Sera utilisé pour faciliter les échanges avec ssh entre appdev et appserv dans une prochaine étape (lors de la préparation du serveur appserv)

    $ mkdir ~/.ssh
    $ chmod 700 ~/.ssh
    $ cd ~/.ssh
    $ ssh-keygen -t rsa -b 4096

    La clé publique est ajoutée à admdev pour permettre le staging via capistrano:

    $ sudo cp id_rsa.pub ~admdev/.ssh/authorized_keys
    $ sudo chown admdev:admdev ~admdev/.ssh/authorized_keys
    $ sudo chmod 600 ~admdev/.ssh/authorized_keys

12. Creation du certificat nécessaire à nginx pour opérer l'application en mode SSL. Requis pour les installations de spaceman et sciencia.

    La commande suivante lancera la création des fichiers de certificat s'ils n'existent pas déjà. Un ensemble de questions seront posées:

    Country Name (2 letter code) [AU]:
    State or Province Name (full name) [Some-State]:
    Locality Name (eg, city) []:
    Organization Name (eg, company) [Internet Widgits Pty Ltd]:
    Organizational Unit Name (eg, section) []:
    Common Name (e.g. server FQDN or YOUR name) []:
    Email Address []:

    À la question entourant le Common Name (FQDN), il faut répondre en utilisant l'adresse IP du poste de développement.

    $ cd ~/Dev
    $ spaceman/src/create-certificate.sh
    $ cd

    Le certificat (fichiers nginx-selfsigned.key et nginx-selfsigned.crf) sont générés dans le répertoire courant qui devrait être ~/Dev, de telle sorte qu'il soit accessible pour les deux applications lors du déploiement via capistrano.

13. Fermer la session (terminal ou ssh)